version: 2

models:
  - name: int_patients__enriched
    description: Deduplicated patient records with calculated age
    columns:
      - name: patient_id
        description: Unique identifier for the patient
        tests:
          - unique
          - not_null
      - name: age_years
        description: Calculated age in years based on date of birth

  - name: int_patient_medications__active
    description: >
      Patient medication administrations joined with patient and medication details.

      **Incremental model** that only processes medication administrations since the
      last run (based on date_started). Run with `--full-refresh` to rebuild.
      Unique key: (patient_id, medication_id, date_started)
    tests:
      - dbt_utils.unique_combination_of_columns:
          arguments:
            combination_of_columns:
              - patient_id
              - medication_id
              - date_started
    columns:
      - name: patient_id
        description: Unique identifier for the patient
        tests:
          - not_null
      - name: medication_id
        description: Unique identifier for the medication
        tests:
          - not_null
      - name: is_currently_active
        description: Boolean indicating if the medication is currently active (no stop date)

  - name: int_visits__with_patient_details
    description: >
      Visits enriched with patient demographics and condition information.

      **Incremental model** that only processes visits since the last run
      (based on visit_date). Run with `--full-refresh` to rebuild.
      Unique key: visit_id
    columns:
      - name: visit_id
        description: Unique identifier for the visit
        tests:
          - unique
          - not_null
      - name: patient_id
        description: Unique identifier for the patient
        tests:
          - not_null
      - name: visit_date
        description: Date of the visit
        tests:
          - not_null

  - name: int_lab_results__with_abnormal_flag
    description: >
      Lab results enriched with abnormality flags based on reference ranges.
      Adds result_status column (HIGH/LOW/NORMAL) by comparing result values
      against component-specific reference ranges.
    columns:
      - name: test_id
        description: Unique identifier for the lab test
        tests:
          - not_null
      - name: result_status
        description: Abnormality flag (HIGH/LOW/NORMAL)
        tests:
          - not_null
          - accepted_values:
              arguments:
                values: ['HIGH', 'LOW', 'NORMAL']