version: 2

models:
  - name: stg_patients
    columns:
      - name: id
        tests:
          - unique
          - not_null
      - name: patient_id
        tests:
          - unique
          - not_null

  - name: stg_orders
    columns:
      - name: order_id
        tests:
          - unique
          - not_null
      - name: patient_id
        tests:
          - not_null
      - name: order_date
        tests:
          - not_null

  - name: stg_conditions
    columns:
      - name: condition_id
        tests:
          - unique
          - not_null
      - name: condition_name
        tests:
          - not_null

  - name: stg_medications
    columns:
      - name: medication_id
        tests:
          - unique
          - not_null
      - name: medication_name
        tests:
          - not_null

  - name: stg_patient_conditions
    columns:
      - name: patient_condition_id
        tests:
          - unique
          - not_null
      - name: patient_id
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('stg_patients')
                field: patient_id
      - name: condition_id
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('stg_conditions')
                field: condition_id
      - name: date_started
        tests:
          - not_null

  - name: stg_visits
    columns:
      - name: visit_id
        tests:
          - unique
          - not_null
      - name: patient_condition_id
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('stg_patient_conditions')
                field: patient_condition_id
      - name: visit_date
        tests:
          - not_null

  - name: stg_med_admins
    columns:
      - name: patient_id
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('stg_patients')
                field: patient_id
      - name: medication_id
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('stg_medications')
                field: medication_id
      - name: date_started
        tests:
          - not_null

  - name: stg_documents
    columns:
      - name: document_id
        tests:
          - not_null
      - name: patient_id
        tests:
          - not_null
      - name: visit_id
        tests:
          - not_null

  - name: stg_lab_results
    description: >
      Staging model for lab test results parsed from JSON files.
      Each row represents one component of a lab test (e.g., one Glucose measurement).
      The testResults array from each JSON file is unnested, so a single test can produce
      multiple rows - one per component measured.
    columns:
      - name: test_id
        description: Unique identifier for the lab test
        tests:
          - not_null
      - name: order_id
        description: Associated order ID
        tests:
          - not_null
      - name: patient_id
        description: Associated patient ID
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('stg_patients')
                field: patient_id
      - name: result_date
        description: Date when the test result was recorded
        tests:
          - not_null
      - name: component_name
        description: Name of the lab component measured (e.g., Glucose, Creatinine)
        tests:
          - not_null
      - name: component_ref_hi
        description: High reference value for this component
      - name: component_ref_lo
        description: Low reference value for this component
      - name: component_units
        description: Units of measurement (e.g., mg/dL, mmol/L)
      - name: result_value
        description: Actual measured value for this component
        tests:
          - not_null